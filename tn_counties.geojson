import streamlit as st
import pandas as pd
import folium
from streamlit_folium import st_folium
import json
import requests

st.set_page_config(page_title="TN Property Map", layout="wide")

# -----------------------------
# 1. LOAD LIVE DATA FROM GOOGLE SHEET
# -----------------------------

SHEET_URL = "PASTE_YOUR_GOOGLE_SHEET_CSV_LINK_HERE"

@st.cache_data(ttl=60)
def load_data():
    df = pd.read_csv(SHEET_URL)

    # Clean county names
    df["County_clean"] = (
        df["County"]
        .astype(str)
        .str.replace(" County", "", case=False)
        .str.strip()
    )
    df["County_clean_up"] = df["County_clean"].str.upper()

    # Fix typo
    df.loc[df["County_clean_up"] == "STEWART COUTY", "County_clean_up"] = "STEWART"

    return df

df = load_data()

# -----------------------------
# 2. LOAD TN COUNTY GEOJSON
# (You can host this anywhere or load it from GitHub)
# -----------------------------

GEOJSON_URL = "https://raw.githubusercontent.com/your_repo/tn_counties.geojson"

@st.cache_data
def load_geojson():
    return requests.get(GEOJSON_URL).json()

tn_geo = load_geojson()

# -----------------------------
# 3. BUILD COUNTY PROPERTY COUNTS + LISTS
# -----------------------------

county_counts = df.groupby("County_clean_up").size().to_dict()

county_properties = {}
for _, row in df.iterrows():
    c = row["County_clean_up"]
    county_properties.setdefault(c, []).append({
        "Address": row["Address"],
        "City": row["City"],
        "SF_URL": row["Salesforce_URL"]
    })

# -----------------------------
# 4. ADD POPUP HTML TO EACH COUNTY
# -----------------------------

for feature in tn_geo["features"]:
    props = feature["properties"]
    name = props["NAME"]
    name_up = name.upper()

    count = county_counts.get(name_up, 0)
    props_list = county_properties.get(name_up, [])

    lines = [
        f"<h4>{name} County</h4>",
        f"<b>Properties sold:</b> {count}<br>"
    ]

    # Scrollable list up to 10 viewable at once
    lines.append('<div style="max-height: 260px; overflow-y: auto; margin-top: 4px;">')
    lines.append("<ul style='padding-left:18px;'>")

    for p in props_list:
        addr = p["Address"]
        city = p["City"]
        url = p["SF_URL"]
        display_text = f"{addr}, {city}" if city else addr

        if pd.notna(url):
            lines.append(f'<li><a href="{url}" target="_blank">{display_text}</a></li>')
        else:
            lines.append(f"<li>{display_text}</li>")

    lines.append("</ul></div>")

    props["POPUP_HTML"] = "\n".join(lines)

# -----------------------------
# 5. COLOR SCALE FUNCTION
# -----------------------------

def category_color(v: int) -> str:
    if v == 0: return "#FFFFFF"
    if v == 1: return "#ADD8E6"
    if 2 <= v <= 5: return "#F4A6A6"
    if 6 <= v <= 10: return "#FFFACD"
    return "#90EE90"

# -----------------------------
# 6. BUILD THE FOLIUM MAP
# -----------------------------

# Compute center of TN
lats = [float(f["properties"]["INTPTLAT"]) for f in tn_geo["features"]]
lons = [float(f["properties"]["INTPTLON"]) for f in tn_geo["features"]]
center_lat = sum(lats)/len(lats)
center_lon = sum(lons)/len(lons)

m = folium.Map(location=[center_lat, center_lon], zoom_start=7, tiles="cartodbpositron")

def style_function(feature):
    v = feature["properties"].get("PROP_COUNT", 0)
    return {
        "fillColor": category_color(v),
        "color": "black",
        "weight": 0.5,
        "fillOpacity": 0.9
    }

# Add property counts
for feature in tn_geo["features"]:
    name_up = feature["properties"]["NAME"].upper()
    feature["properties"]["PROP_COUNT"] = county_counts.get(name_up, 0)

# Add GeoJson layer
folium.GeoJson(
    tn_geo,
    name="TN Counties",
    style_function=style_function,
    tooltip=folium.GeoJsonTooltip(
        fields=["NAME", "PROP_COUNT"],
        aliases=["County:", "Properties sold:"]
    ),
    popup=folium.GeoJsonPopup(
        fields=["POPUP_HTML"],
        parse_html=True,
        labels=False,
        max_width=500
    )
).add_to(m)

# -----------------------------
# 7. ADD LEGEND + WATERMARK
# -----------------------------

legend_html = """
<div style="
    position: fixed;
    bottom: 80px; left: 30px;
    background-color: white;
    padding: 10px;
    border: 2px solid black;
    border-radius: 6px;
    z-index: 9999;">
<b>Legend</b><br>
<span style="background:#FFFFFF; padding:4px 10px; border:1px solid #000;"></span> 0 properties<br>
<span style="background:#ADD8E6; padding:4px 10px; border:1px solid #000;"></span> 1 property<br>
<span style="background:#F4A6A6; padding:4px 10px; border:1px solid #000;"></span> 2–5<br>
<span style="background:#FFFACD; padding:4px 10px; border:1px solid #000;"></span> 6–10<br>
<span style="background:#90EE90; padding:4px 10px; border:1px solid #000;"></span> >10<br>
</div>
"""
m.get_root().html.add_child(folium.Element(legend_html))

watermark_html = """
<div style="
    position: fixed;
    bottom: 35px; left: 30px;
    background-color: rgba(255,255,255,0.75);
    padding: 6px 12px;
    border: 1px solid black;
    border-radius: 6px;
    font-weight: bold;
    z-index:9999;">
Created by Keith Frislid
</div>
"""
m.get_root().html.add_child(folium.Element(watermark_html))

# -----------------------------
# 8. DISPLAY MAP IN STREAMLIT
# -----------------------------

st.title("Tennessee Property Acquisition Map")
st.write("This map pulls live data from your Google Sheet.")

st_folium(m, width=900, height=650)
